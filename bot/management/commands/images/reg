from django.core.management.base import BaseCommand
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, CallbackQuery
from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ContextTypes
import os
from bot.models import UserRegistration
import asyncio

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "7795385929:AAF98EsKowGgpg9wgEN91qpZZh5x5tLHTcM")

LANGUAGE_SELECTION_IMAGE = "bot/management/commands/images/lang.jpg"
MAIN_MENU_IMAGE = "bot/management/commands/images/menu.jpg"
GAME_MENU_IMAGE = "bot/management/commands/images/games.jpg"

async def delete_previous_message(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    chat_id = update.effective_chat.id
    if isinstance(update.callback_query, CallbackQuery):
        chat_id = update.callback_query.message.chat_id
        
    previous_message_id = context.user_data.get('previous_message_id')
    if previous_message_id:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=previous_message_id)
        except Exception as e:
            print(f"Error deleting message: {e}")
    
    # Also try to delete the message that triggered the callback
    if isinstance(update.callback_query, CallbackQuery):
        try:
            await update.callback_query.message.delete()
        except Exception as e:
            print(f"Error deleting callback message: {e}")

def get_text(context, ru_text, en_text):
    return ru_text if context.user_data.get('language') == 'ru' else en_text

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await delete_previous_message(update, context)
    
    language_keyboard = [
        [InlineKeyboardButton("ðŸ‡·ðŸ‡º Ð ÑƒÑÑÐºÐ¸Ð¹", callback_data='lang_ru')],
        [InlineKeyboardButton("ðŸ‡¬ðŸ‡§ English", callback_data='lang_en')]
    ]
    reply_markup = InlineKeyboardMarkup(language_keyboard)

    with open(LANGUAGE_SELECTION_IMAGE, 'rb') as photo:
        message = await context.bot.send_photo(
            chat_id=update.effective_chat.id,
            photo=photo,
            caption="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ·Ñ‹Ðº / Choose your language:",
            reply_markup=reply_markup
        )
        context.user_data['previous_message_id'] = message.message_id

async def language_selected(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    await delete_previous_message(update, context)

    if query.data == 'lang_ru':
        context.user_data['language'] = 'ru'
    else:
        context.user_data['language'] = 'en'

    await show_main_menu(update, context)

async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    await delete_previous_message(update, context)
    
    menu_text = get_text(context, "Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ð³Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ!", "Welcome to the main menu!")

    main_menu_keyboard = [
        [InlineKeyboardButton(get_text(context, "ðŸŽ® Ð˜Ð³Ñ€Ð°Ñ‚ÑŒ", "ðŸŽ® Play"), callback_data='play')],
        [InlineKeyboardButton(get_text(context, "ðŸ‘¥ ÐšÐ°Ð½Ð°Ð»", "ðŸ‘¥ Channel"), url="https://t.me/txitNGBrugg5MTRi")],
        [InlineKeyboardButton(get_text(context, "ðŸŒ Ð¡Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÐ·Ñ‹Ðº", "ðŸŒ Change Language"), callback_data='start')]
    ]
    reply_markup = InlineKeyboardMarkup(main_menu_keyboard)

    with open(MAIN_MENU_IMAGE, 'rb') as photo:
        message = await context.bot.send_photo(
            chat_id=update.effective_chat.id,
            photo=photo,
            caption=menu_text,
            reply_markup=reply_markup
        )
        context.user_data['previous_message_id'] = message.message_id

async def play(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    await delete_previous_message(update, context)

    if context.user_data.get('done_subscribing', False):
        await show_games_menu(query, context)
    else:
        message = await query.message.reply_text(
            get_text(
                context,
                "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð½Ð° Ð²ÑÑ‚ÑƒÐ¿Ð»ÐµÐ½Ð¸Ðµ Ð² Ð½Ð°Ñˆ ÐºÐ°Ð½Ð°Ð» Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾', Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ.",
                "Please send a request to join our channel and click 'Done' to continue."
            ),
            reply_markup=InlineKeyboardMarkup([
                [InlineKeyboardButton(get_text(context, "ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² ÐºÐ°Ð½Ð°Ð»", "Go to Channel"), url="https://t.me/+txitNGBrugg5MTRi")],
                [InlineKeyboardButton(get_text(context, "Ð“Ð¾Ñ‚Ð¾Ð²Ð¾", "Done"), callback_data='continue_after_subscribe')],
                [InlineKeyboardButton(get_text(context, "ÐÐ°Ð·Ð°Ð´", "Back"), callback_data='show_main_menu')]
            ])
        )
        context.user_data['previous_message_id'] = message.message_id

async def continue_after_subscribe(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    await delete_previous_message(update, context)

    context.user_data['done_subscribing'] = True
    message = await query.message.reply_text(
        get_text(
            context,
            "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð²Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ.",
            "Thank you! You can now continue."
        )
    )
    context.user_data['previous_message_id'] = message.message_id
    
    await asyncio.sleep(2)
    await show_games_menu(query, context)

async def show_games_menu(query, context: ContextTypes.DEFAULT_TYPE) -> None:
    chat_id = query.message.chat.id
    previous_message_id = context.user_data.get('previous_message_id')
    if previous_message_id:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=previous_message_id)
        except Exception as e:
            print(f"Error deleting message: {e}")

    games_keyboard = [
        [
            InlineKeyboardButton("âœˆï¸ Aviator", callback_data='game_1'),
            InlineKeyboardButton("ðŸš€ LuckyJet", callback_data='game_2'),
            InlineKeyboardButton("ðŸš— Speed&Cash", callback_data='game_3')
        ],
        [
            InlineKeyboardButton("ðŸ’£ Mines", callback_data='game_4'),
            InlineKeyboardButton("ðŸ‘‘ Royal Mines", callback_data='game_5'),
            InlineKeyboardButton("ðŸª¦ Brawl Pirates", callback_data='game_6')
        ],
        [
            InlineKeyboardButton(get_text(context, "ÐÐ°Ð·Ð°Ð´", "Back"), callback_data='show_main_menu')
        ]
    ]
    reply_markup = InlineKeyboardMarkup(games_keyboard)

    with open(GAME_MENU_IMAGE, 'rb') as photo:
        message = await context.bot.send_photo(
            chat_id=chat_id,
            photo=photo,
            caption=get_text(context, "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð³Ñ€Ñƒ:", "Choose a game:"),
            reply_markup=reply_markup
        )
        context.user_data['previous_message_id'] = message.message_id
        
async def game_selected(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    await delete_previous_message(update, context)

    selected_game = query.data.split('_')[-1]

    # Ð˜Ð¼Ð¸Ñ‚Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð½Ð° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ
    registration_message = get_text(
        context,
        "ðŸ‘‹ Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ!, Ð§Ñ‚Ð¾Ð±Ñ‹ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ„Ñ„ÐµÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ Ð¾Ñ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð±Ð¾Ñ‚Ð°, Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:\n"
        "1. Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚ - ÐµÑÐ»Ð¸ Ñƒ Ð’Ð°Ñ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾ÐºÐ¸Ð½ÑŒÑ‚Ðµ ÐµÐ³Ð¾ Ð¸ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹.\n"
        "2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´ ABUZNIK24 Ð¿Ñ€Ð¸ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°. Ð­Ñ‚Ð¾ Ð²Ð°Ð¶Ð½Ð¾, Ñ‚Ð°Ðº ÐºÐ°Ðº Ð½Ð°Ñˆ Ð˜Ð˜ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ Ð½Ð¾Ð²Ñ‹Ð¼Ð¸ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°Ð¼Ð¸.\n"
        "3. ÐŸÐ¾ÑÐ»Ðµ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸ Ð½Ð°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° ÐºÐ½Ð¾Ð¿ÐºÑƒ â€œÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽâ€.\n"
        "4. Ð•ÑÐ»Ð¸ Ð’Ñ‹ Ð½Ðµ Ð²Ñ‹Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ ÑÑ‚Ð¸ ÑˆÐ°Ð³Ð¸, Ð½Ð°Ñˆ Ð±Ð¾Ñ‚ Ð½Ðµ ÑÐ¼Ð¾Ð¶ÐµÑ‚ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð’Ð°Ñˆ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚ Ð² ÑÐ²Ð¾ÑŽ Ð±Ð°Ð·Ñƒ Ð´Ð°Ð½Ð½Ñ‹Ñ…, Ð¸ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼Ñ‹Ðµ Ð¸Ð¼ ÑÐ¸Ð³Ð½Ð°Ð»Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð½Ðµ Ð¿Ð¾Ð´Ð¾Ð¹Ñ‚Ð¸.\n"
        "Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾ Ð·Ð° Ð¿Ð¾Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ!",
        "ðŸ‘‹ Hello!, To get the most out of this bot, you need to follow these steps:\n"
        "1. Register a new account - if you already have an account, please leave it and register a new one.\n"
        "2. Use the promo code ABUZNIK24 when registering a new account. This is important, as our AI only works with new accounts.\n"
        "3. After registration, click on the â€œCheck registrationâ€ button.\n"
        "4. If you do not follow these steps, our bot will not be able to add your account to its database, and the signals it provides may not be suitable.\n"
        "Thank you for your understanding!"
    )
    registration_keyboard = [
        [InlineKeyboardButton(get_text(context, "Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ", "Register"), url="https://1wayto.life/?p=mn62")],
        [InlineKeyboardButton(get_text(context, "ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸ÑŽ", "Check Registration"), callback_data='check_registration')],
        [InlineKeyboardButton(get_text(context, "ÐÐ°Ð·Ð°Ð´", "Back"), callback_data='go_back')]
    ]
    reply_markup = InlineKeyboardMarkup(registration_keyboard)

    await query.message.reply_text(
        registration_message,
        reply_markup=reply_markup
    )

async def check_registration(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()

    not_registered_message = get_text(
        context,
        "Ð’Ñ‹ Ð½Ðµ Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐ¹Ñ‚ÐµÑÑŒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ.",
        "You are not registered. Please register to continue."
    )
    
    await query.message.reply_text(not_registered_message)

async def go_back(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    await delete_previous_message(update, context)
    await show_games_menu(query, context)

async def change_language(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    query = update.callback_query
    await query.answer()
    await delete_previous_message(update, context)
    await start(update, context)

class Command(BaseCommand):
    help = 'Telegram Bot'

    def handle(self, *args, **kwargs):
        application = Application.builder().token(TELEGRAM_TOKEN).build()

        application.add_handler(CommandHandler("start", start))
        application.add_handler(CallbackQueryHandler(language_selected, pattern="^lang_"))
        application.add_handler(CallbackQueryHandler(change_language, pattern="^lang_change$"))
        application.add_handler(CallbackQueryHandler(play, pattern="^play$"))
        application.add_handler(CallbackQueryHandler(go_back, pattern="^go_back$"))
        application.add_handler(CallbackQueryHandler(game_selected, pattern="^game_"))
        application.add_handler(CallbackQueryHandler(start, pattern="^start$"))
        application.add_handler(CallbackQueryHandler(show_main_menu, pattern="^show_main_menu$"))
        application.add_handler(CallbackQueryHandler(check_registration, pattern="^check_registration$"))
        application.add_handler(CallbackQueryHandler(continue_after_subscribe, pattern="^continue_after_subscribe$"))

        application.run_polling()

       